---
layout: post
title: Mach-O格式分析
categories: osx/ios 底层
description: 
keywords: Mach-O
---




## 0x00 摘要
> 道可道，非常道。名可名，非常名。无名天地之始；有名万物之母。此常无，欲以观其妙；常有，欲以观其徼。此两者，同出而异名，同谓之玄。玄之又玄，众妙之门。
> ——《道德经》  

`mach-o` 格式是OS X系统上可执行文件的格式，跟windows下的 `PE` 及 linux 下的 `ELF` 一样，对其文件格式的具体内容的研究，是对对应平台 `逆向工程` 的最最基础的任务，如果不彻底搞清楚 `mach-o` 的格式与相关知识，去做其他研究，无异于建造空中楼阁。  
每个 Mach-O 文件包含一个 `Mach-O 头`，然后是 `载入命令（Load Commands）`,最后是 `数据块（Data）`。  

接下来，就对整个 Mach-O 的格式做出详细的分析。  
## 0x01 Mach-O 格式简单介绍
Mach-O 文件的格式如下图所示：  
![](/images/posts/macho/macho_header.jpg)  
有如下几个部分组成：  
* Header: 保存了 Mach-O 的一些基本信息，包括了平台、文件类型、LoadCommands的个数等等。
* LoadCommands: 这一段紧跟Header，加载Mach-O 文件时会使用这里的数据来确定内存的分布。
* Data:每一个segment的具体数据都保存在这里，这里包含了具体的代码、数据等等。  

## 0x02 Headers  
### 2.1 数据结构  
Headers的定义可以在开源的内核代码中找到：  

```
/*
 * The 32-bit mach header appears at the very beginning of the object file for
 * 32-bit architectures.
 */
struct mach_header {
	uint32_t	magic;		/* mach magic number identifier */
	cpu_type_t	cputype;	/* cpu specifier */
	cpu_subtype_t	cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
};

/* Constant for the magic field of the mach_header (32-bit architectures) */
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */

/*
 * The 64-bit mach header appears at the very beginning of object files for
 * 64-bit architectures.
 */
struct mach_header_64 {
	uint32_t	magic;		/* mach magic number identifier */
	cpu_type_t	cputype;	/* cpu specifier */
	cpu_subtype_t	cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
	uint32_t	reserved;	/* reserved */
};

/* Constant for the magic field of the mach_header_64 (64-bit architectures) */
#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */
#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */
```  

根据 `mach_header` 与 `mach_header_64` 的定义，很明显可以看出，Headers的主要作用就是帮助系统迅速的定位 Mach-O 文件的运行环境、文件类型等等。  
![](/images/posts/macho/header_detail.png)   

### 2.2实例
使用工具分析一个 mach-o 文件，看一下 `Mach-O Headers`。  
通过 otool 可以得到 Mach-O Headers 的具体情况。  
![](/images/posts/macho/header_detail.png)  
还有一个工具是 MachOView 可以看的更清楚一点。  
![](/images/posts/macho/tool_show_header.png)  





